# HC Robotics - HCR-523 CAN L1/L5 GPS + Magnetometer
# STM32G491KEU6
# GPS Module: uBlox NEO-F10T
# Antenna: Taoglas GPVSF.25.8.A.08
# Magnetometer: PNI RM3100 
# CAN: 1 FDCAN 8Mbit
# Backup Power: 11MF Super Cap
# TimePulse signal and USB signals via JST Connector
# 3 Status LEDs: Status (Blue), GPS Power (Green), MCU Power (Green)
#
# USB and CAN share the single UART on the F10T, it is muxed so that the USB will supercede the onboard MCU if connected
###########################################################################################################################################################

# MCU class and specific type
MCU STM32G4xx STM32G491xx

# default to all pins low to avoid ESD issues
# wait to enable until every IO is accounted for below.
DEFAULTGPIO OUTPUT LOW PULLDOWN

# use DNA
define HAL_CAN_DEFAULT_NODE_ID 0

FLASH_RESERVE_START_KB 36

STORAGE_FLASH_PAGE 16
define HAL_STORAGE_SIZE 800

# board ID for firmware load
APJ_BOARD_ID AP_HW_HCR-523

# setup build for a peripheral firmware
env AP_PERIPH 1

# enable watchdog
define HAL_WATCHDOG_ENABLED_DEFAULT 1

# crystal frequency
OSCILLATOR_HZ 8000000

# assume 512k flash part
FLASH_SIZE_KB 512

# a LED to flash
PA15 LED OUTPUT HIGH # blue
define HAL_LED_ON 1

# SWD debugging
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# USART1, GPS
PA9 USART1_TX USART1
PA10 USART1_RX USART1

# order of UARTs
SERIAL_ORDER USART1

# disable dual GPS and GPS blending to save flash space
define GPS_MAX_RECEIVERS 1
define GPS_MAX_INSTANCES 1
define HAL_COMPASS_MAX_SENSORS 1

DMA_NOSHARE USART1*

# GPS+MAG+LEDs
define AP_PERIPH_GPS_ENABLED 1
define AP_PERIPH_MAG_ENABLED 1

# GPS on 1st port
define HAL_PERIPH_GPS_PORT_DEFAULT 0

# one SPI bus
PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1

# SPI CS
PA4 MAG_CS CS

# RM3100 interrupt pin. May not be supported.
PA3 RM3100_DRDY INPUT PULLDOWN

# SPI devices
SPIDEV rm3100 SPI1 DEVID1 MAG_CS MODE0  1*MHZ  1*MHZ

# compass
COMPASS RM3100 SPI:rm3100 false ROTATION_NONE

define HAL_BARO_ALLOW_INIT_NO_BARO

define HAL_USE_ADC FALSE
define STM32_ADC_USE_ADC1 FALSE
define HAL_DISABLE_ADC_DRIVER TRUE

define HAL_USE_RTC FALSE

define HAL_RCIN_THREAD_ENABLED 0

define DMA_RESERVE_SIZE 0
define HAL_SCHEDULER_LOOP_DELAY_ENABLED 0

PA11 CAN1_RX CAN1
PA12 CAN1_TX CAN1

define CAN_APP_NODE_NAME "com.hcrobo.HCR-523"

define HAL_LOGGING_ENABLED 0
define HAL_MONITOR_THREAD_ENABLED 0

define HAL_DEVICE_THREAD_STACK 768

# we setup a small defaults.parm
define AP_PARAM_MAX_EMBEDDED_PARAM 256

# keep ROMFS uncompressed as we don't have enough RAM
# to uncompress the bootloader at runtime
env ROMFS_UNCOMPRESSED True
